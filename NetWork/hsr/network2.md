# 3주 차 TCP/IP 4계층

---

## ***TCP/IP 4계층 - 개념, 캡슐화, 비캡슐화, PDU, OSI 7계층***

> TCP/IP 4계층은 장치들이 인터넷 상에서 데이터를 주고받을 때 쓰는 **독립적**인 프로토콜의 집합을 의미한다.
> 
- 참고
    
    TCP/IP는 TCP(Transmission Control Protocol) / IP(Internet Protocol)이라는 의미인데 인터넷을 통해 데이터를 보낼 때 주로 TCP와 IP를 이용해서 보내기 때문에 이런 용어를 가진다.
    

- Appliation(응용계층) : SMTP, HTTP/HTPS, FTP, SSH
- Transport (전송계층): UDP, TCP
- Internet(인터넷계층) : IPv4/IPv6, ICMP, ARP
- Network Access(링크계층)

**애플리케이션 계층(application)**

: HTTP, SMTP, SSH, FTP가 대표적이며 웹 서비스, 이메일 등 서비스를 실질적으로 사람들에게 제공하는 층.

**전송 계층(transport)**

: TCP, UDP가 대표적이며 애플리케이션계층에서 받은 메시지를 기반으로 세그먼트 또는 데이터그램으로 데이터를 쪼개고 데이터가 오류없이 순서대로 전달되도록 도움을 주는 층.

**인터넷 계층(network)**

: IP, ICMP, ARP가 대표적이며 한 노드에서 다른 노드로 전송 계층에서 받은 세그먼트 또는 데이터그램을 패킷화 하여 목적지로 전송하는 역할을 담당하는 층(주소 역할).

**링크 계층(link)**

: 링크 계층은 전선, 광섬유, 무선 등으로 데이터가 네트워크를 통해 물리적으로 전송되는 방식을 정의합니다.

### **캡슐화와 비캡슐화**

**캡슐화**

> 네트워크에서 캡슐화(encapsulation)란 송신자가 수신자에게 데이터를 보낼 때 데이터가 각 계층을 지나며 각 계층의 특징들이 담긴 헤더들이 붙여지는 과정을 의미한다.
> 

Ex) 전송계층은 TCP 헤더, 네트워크 계층은 IP 주소 헤더를 추가하는 것

**비캡슐화(decapsulation)**

> 캡슐화의 역과정
> 

수신자측에서는 이렇게 캡슐화된 데이터를 역순으로 제거하면서 응용계층까지 도달하는 것을 말한다.

**PUD(protocol data unit)**

> TCP/IP 4계층을 기반으로 설명했을 때 각 계층의 데이터 단위를 의미한다.
> 

- 애플리케이션 계층 : 메시지
- 전송 계층 : 세그먼트(TCP), 데이터그램(UDP)
- 인터넷 계층 : 패킷
- 링크 계층 : 프레임(데이터 링크 계층), 비트(물리 계층)

세그먼트 : 적절한 크기로 쪼갠 조각 (세그먼트와 데이터그램의 의미는 같습니다.)

패킷 : 세그먼트에 SP와 DP가 포함된 IP 헤더가 붙은 형태의 조각

프레임 : MAC주소 헤더와 CRC/체크성 트레일러가 붙은 조각

SP : 송신자의 32비트 IP주소

DP : 수신자의 32비트 IP주소

CRC/체크성 트레일러 : 데이터의 오류 감지를 위한 수학적 함수가 적용된 값. 링크의 오류(과도한 트래픽 등)로 인해 데이터 손상을 감지하는 역할을 한다.

참고로 모든 계층에 전달되는 데이터가 쪼개져서 ‘패킷’으로 전달된다고도 하는 것도 대강 맞는 말이나 PDU에 따라 부르는 게 더 맞는 표현.

### **OSI 7계층**

TCP/IP 4계층을 OSI 7계층으로 설명하기도 한다.

![Untitled](3%E1%84%8C%E1%85%AE%20%E1%84%8E%E1%85%A1%20TCP%20IP%204%E1%84%80%E1%85%A8%E1%84%8E%E1%85%B3%E1%86%BC%2053529094982d4810a162d01314bb9b11/Untitled.png)

---

## ***TCP/IP 4계층 – 2.MTU와 MSS와 PMTUD***

패킷으로 쪼개질 때 MTU(Maximum Transmission Unit)를 기반으로 쪼개진다. MTU는 네트워크 통신할 때 할 수 있는 가장 큰 PDU의 크기를 말한다.

Ex) 터널의 높이제한

### **MTU와 MSS**

> MTU는 IP헤더와 TCP헤더의 크기까지 합치지만 MSS(Maximum Segment Size)는 TCP에서 사용할 수 있는 데이터의 크기 이자 TCP 헤더, IP헤더를 뺀 크기를 말한다.
> 

일반적으로 MTU는 1500바이트이며 MSS는 1460바이트, 그렇기 때문에 MTU가 1500이라도 데이터는 보통 1460바이트 이하의 크기로 보내야 전달 된다.

**패킷이 분할되지 않는 경우**

패킷을 분할할 수 없어 네트워크 경로 상에 있는 어떠한 라우터나 장치의 MTU를 초과할 때 분할해서 전달하는 것이 아니라 전달을 아예 하지 않을 수도 있다.

**PMTUD**

> PMTUD(Path MTU Discovery)는 수신자와 송신자의 경로 상에서 장치가 패킷을 누락한 경우 테스트 패킷의 크기를 낮추면서 MTU에 맞게끔 반복해서 보내는 과정을 말한다.
> 

## *TCP/IP 4계층 - 3. 애플리케이션 계층*

HTTP, SMTP, SSH, FTP가 대표적이며 웹 서비스, 이메일 등 서비스를 실질적으로 사람들에게 제공하는 층

### **HTTP**

> HTTP(Hypertext Transfer Protocol)은 처음에는 서버와 브라우저간에 데이터를 주고 받기 위해 설계된 프로토콜입니다. 지금은 브라우저뿐만 아니라 서버와 서버 간의 통신할 때도 많이 이용합니다.
> 

1. HTTP는 헤더를 통한 확장이 쉽다.
2. HTTP는 stateless하다.

: 동일한 연결에서 연속적으로 수행되는 두 요청 사이에 연속적인 상태(state)값은 없다.

### **SSH**

> SSH(Secure SHhell Protocol)는 보안되지 않은 네트워크에서 네트워크 서비스를 안전하게 운영하기 위한 암호화 네트워크 프로토콜이다.
> 

### **FTP**

> FTP(File Transfer Protocol)는 노드와 노드 간의 파일을 전송하는데 사용되는 프로토콜. 지금은 파일을 암호화해서 전송하는 FTPS 또는 SFTP로 대체되고 있다.
> 

### **SMTP**

> 인터넷을 통해 메일을 보낼 때 사용되는 프로토콜(Simple Mail Transfer Protocol)
> 

보통 서비스를 운영하면 메일링 서비스를 하게 되는데 node.js를 통해 메일을 보낸다면 이를 통해 보내야 한다.

---

## ***TCP/IP 4계층 - 4. 전송 계층(transport) TCP와 UDP***

> TCP, UDP가 대표적이며 애플리케이션계층에서 받은 메시지를 기반으로 세그먼트(TCP) 또는 데이터그램(UDP)으로 데이터를 쪼개고 데이터가 오류없이 순서대로 전달되도록 도움을 주는 층
> 

### **TCP**

- 가상회선 패킷 교환 방식

![Untitled](3%E1%84%8C%E1%85%AE%20%E1%84%8E%E1%85%A1%20TCP%20IP%204%E1%84%80%E1%85%A8%E1%84%8E%E1%85%B3%E1%86%BC%2053529094982d4810a162d01314bb9b11/Untitled%201.png)

- 오류 검사 메커니즘
    1. 재전송 : 시간 초과 기간이 지나면 서버는 전달되지 않은 데이터에 대해 재전송을 시도합니다.
    2. 체크섬 : 체크섬을 통해 무결성을 평가합니다. 즉, 송신된 데이터의 체크섬과 수신된 데이터의 체크섬 값을 비교해서 올바르게 왔는지를 확인
- 헤더 : 20~60바이트로 가변적

### **UDP**

- 데이터그램 패킷 교환 방식

![Untitled](3%E1%84%8C%E1%85%AE%20%E1%84%8E%E1%85%A1%20TCP%20IP%204%E1%84%80%E1%85%A8%E1%84%8E%E1%85%B3%E1%86%BC%2053529094982d4810a162d01314bb9b11/Untitled%202.png)

- 오류검사는 단순한 체크섬만 지원
- 헤더 : 32비트(8바이트)로 고정길이

**⭐차이점⭐**

|  | 전송 제어 프로토콜(TCP) | 사용자 데이터그램 프로토콜(UDP) |
| --- | --- | --- |
| 패킷교환방식 | 가상회선 패킷 교환 방식 | 데이터그램 패킷 교환 방식 |
| 신뢰성 | O | X |
| 오류검사 | 재전송, 체크섬 | 체크섬 |
| 패킷의 순서 보장 | O | X |
| 헤더 길이 | (20-60)바이트 가변 길이 | 8바이트 고정 길이 |
| 연결 보장 | 연결을 보장함. 3웨이 – 핸드셰이크로 연결을 맺고, 4웨이 – 핸드셰이크로 연결을 해제하는 작업이 필요. | 연결을 보장하지 않음. 그냥 데이터를 보냄. 연결을 유지하고 해제하는데 드는 비용이 없음. |
| 브로드캐스트 지원 | X | O |
| 속도 | 느림 | 빠름 |

 ****

---

## ***TCP/IP 4계층 - 5. 인터넷계층(network)과 ICMP***

### **인터넷계층**

> IP, ICMP, ARP가 대표적이며 한 노드에서 다른 노드로 전송 계층에서 받은 세그먼트 또는 데이터그램을 패킷화 하여 전송한다.
> 

### **ICMP**

> ICMP(Internet Control Message Protocol)는 노드와 노드 사이에서 통신이 잘되나를 확인할 때 쓰는 프로토콜.
> 

이는 데이터를 교환하는데 사용되지 않는 프로토콜이다.

일반적으로 테스팅에 사용된다.

IP와는 달리 TCP 또는 UDP와 같은 전송 계층 프로토콜과 연관되지 않고 독립적인 비연결형 프로토콜로, 이것은 ICMP를 비연결형 프로토콜을 기반으로 구축된다.

---

## ***TCP의 연결성립 : 3-웨이 핸드셰이크***

1. SYN 단계 : 클라이언트는 서버에 클라이언트의 ISN을 담아 SYN을 보냄.
2. SYN + ACK 단계 : 서버는 클라이언트의 SYN을 수신하고 서버의 ISN을 보내며 승인번호로 클라이언트의 ISN + 1을 보냄
3. ACK 단계 : 클라이언트는 서버의 ISN + 1한 값인 승인번호를 담아 ACK를 서버에 보냄.

![Untitled](3%E1%84%8C%E1%85%AE%20%E1%84%8E%E1%85%A1%20TCP%20IP%204%E1%84%80%E1%85%A8%E1%84%8E%E1%85%B3%E1%86%BC%2053529094982d4810a162d01314bb9b11/Untitled%203.png)

ISN : TCP(Transmission Control Protocol) 기반 데이터를 통신에서 각각의 새 연결에 할당된 고유한 32비트 시퀀스 번호를 나타낸다. TCP연결을 통해 전송되는 다른 데이터 바이트와 충돌하지 않는 시퀀스 번호를 할당하는데 도움이 된다.

SYN : synchronization의 약자, 연결 요청 플래그

ACK : acknowledgement의 약자, 응답 플래그

### **클라이언트와 서버의 상태**

이러한 서버와 클라이언트 간의 연결 설정 과정이 있기 때문에 TCP는 신뢰성이 있다. 이러한 과정이 없기 때문에 UDP는 신뢰성이 없다.라고 말한다.

### **LISTEN**

> 서버는 클라이언트의 연락을 기다리는 상태, 이를 기반으로 서버 메서드의 이름이 결정됨.
> 

---

## ***TCP의 연결해제 : 4-웨이 핸드셰이크와 TIME_WAIT***

1. 먼저 클라이언트가 연결을 닫으려고 할 때 FIN으로 설정된 세그먼트를 보낸다. 그리고 클라이언트는 FIN_WAIT_1 상태로 들어가고 서버의 응답을 기다린다.
2. 서버는 클라이언트로 ACK라는 승인 세그먼트를 보내고 CLOSE_WAIT 상태에 들어간다. 클라이언트가 세그먼트를 받으면 FIN_WAIT_2 상태에 들어간다.
3. 서버는 LAST_ACK 상태가 되며 일정 시간 이후에 클라이언트에 FIN이라는 세그먼트를 보낸다.
4. 클라이언트는 TIME_WAIT 상태가 되고 다시 서버로 ACK를 보내서 서버는 CLOSED 상태가 되며 이후 클라이언트는 어느 정도의 시간(TIME_WAIT으로 설정된 시간)을 대기한 후 연결이 닫힌다.
5. 

![Untitled](3%E1%84%8C%E1%85%AE%20%E1%84%8E%E1%85%A1%20TCP%20IP%204%E1%84%80%E1%85%A8%E1%84%8E%E1%85%B3%E1%86%BC%2053529094982d4810a162d01314bb9b11/Untitled%204.png)

### **TIME_WAIT**

지연 패킷이 발생했을 때 데이터 무결성을 해결하기 위함. 두 배의 최대 세그먼트 수명(MSL)시간을 기다린다. 기본적으로 MSL은 2분이다. 소켓이 바로 소멸되지 않고 일정 시간 유지되는 상태를 말하며 지연 패킷 등의 문제점을 해결하는 데 쓰인다.

또한 연결을 올바르게 닫힌 상태로 만들기 위해 존재한다. 예를 들어 CLOSED가 아닌 LAST_ACK로 되어 있으면 그 다음 연결 때 오류가 나타난다.

---

## ***라우팅 1. 개념과 라우터***

### **라우팅**

> 라우팅(routing)은 네트워크에서 데이터를 보낼 때 최적의 경로를 선택하는 과정이며 라우터가 이를 수행한다.
> 

![Untitled](3%E1%84%8C%E1%85%AE%20%E1%84%8E%E1%85%A1%20TCP%20IP%204%E1%84%80%E1%85%A8%E1%84%8E%E1%85%B3%E1%86%BC%2053529094982d4810a162d01314bb9b11/Untitled%205.png)

데이터는 보통 출발지에서 목적지로 가는 동안 여러 개의 라우터를 거치며 여러 번이며 라우팅을 수행한다. (라우팅은 보통 초당 수백만 번 일어난다.)

### **라우터**

> 라우터는 네트워크 사이에서 데이터를 전달하는 장치이며 보통 둘 이상의 서로 다른 네트워크에 연결된다.
> 

![Untitled](3%E1%84%8C%E1%85%AE%20%E1%84%8E%E1%85%A1%20TCP%20IP%204%E1%84%80%E1%85%A8%E1%84%8E%E1%85%B3%E1%86%BC%2053529094982d4810a162d01314bb9b11/Untitled%206.png)

데이터를 목적지로 보낼 때 최적의 경로를 결정하고 경로가 결정되면 해당 경로로 데이터를 넘겨주는 일(라우팅)을 수행한다. 라우터는 라우팅 테이블을 기반으로 데이터를 다음 목적지에 전달한다.

---

## ***라우팅 2. 라우팅 테이블***

### **라우팅 테이블**

> 라우팅 테이블은 IP주소를 기반으로 라우터의 위치를 저장한 테이블 또는 데이터베이스이며 다양한 네트워크에 대한 정보와 해당 네트워크에 연결하는 방법이 포함되어 있다.
> 

### **라우팅 테이블의 구성요소**

- 네트워크 대상(Network Destination) : 목적지 네트워크의 IP 주소
- 서브넷 마스크(Netmask) : 대상 주소를 설명할 때 쓰일 값
- 게이트웨이(Gateway) : 이 장치와 연결되어 있는 홉, 패킷이 전달되는 다음 IP주소(외부 네트워크와 연결된 장치) 만약 목적지가 로컬 네트워크라면 ‘연결됨(connected)’이라고 표기 되며 다른 네트워크라면 해당 네트워크의 게이트웨이를 가리킨다.
- 인터페이스(interface) : 게이트웨이로 가기 위해 거치는 장치.
- 메트릭(Metric) : 우선순위라고도 불리며 패킷 전송을 위해 최적의 경로가 선택되도록 참고되는 값. 동일한 라우팅테이블 요소가 2개 있을 때 이 값이 낮은 요소가 선택된다. 메트릭은 일반적으로 홉 수(hop count)가 들어가며 지연시간, 처리량 등이 들어갈 수 있다.

### **게이트웨이**

> 게이트웨이는 프로토콜 변환기라고도 하며 네트워크와 네트워크를 잇는 장치이다. 라우터와 하는 기능 자체가 비슷하다.
> 

### **홉**

홉(hop)은 네트워크에서 출발지와 목적지 사이에 위치한 장치를 의미하며 홉 카운트(hop count)는 데이터가 출발지와 목적지 사이에서 통과해야 하는 홉의 개수를 의미한다.

참고로 라우팅을 홉 바이 홉 통신이라고도 한다.
